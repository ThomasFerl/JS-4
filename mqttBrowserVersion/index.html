<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT WebApp</title>
    <script src="mqtt.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>WAGO - MQTT - Empf√§nger</h1>
        <div class="form-group">
            <label for="broker">Broker URL:</label>
            <input type="text" id="broker" value="mqtt://localhost:4701">
        </div>
        <div class="form-group">
            <label for="topic">Topic:</label>
            <input type="text" id="topic" value="wago/mqtt/test">
        </div>
        <div class="buttons">
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            <button id="clearBtn" onclick="cls()">clearLog</button> 

        </div>

        <h2>Received Messages:</h2>
        <div id="messages" class="messages"></div>
    </div>

    <script>

        let client= null;

        function disconnect()
        {
            if (client) client.end();
        }

        function cls()
        {
            document.getElementById('messages').innerHTML = '';
        }

        function connect()
        {
            const broker = document.getElementById('broker').value;
            console.log('Broker:', broker);

            const topic = document.getElementById('topic').value;
            console.log('Topic:', topic);

            // Connect to the MQTT broker
            client = mqtt.connect(broker);

            client.on('connect', () => {
                                         console.log('Connected to broker:', broker);
                                         client.subscribe( topic , (err) => {
                                                                              if (!err) {
                                                                                          console.log('Subscribed to topic:', topic);
                                                                                          document.getElementById('connectBtn').disabled = true;
                                                                                          document.getElementById('disconnectBtn').disabled = false;
                                                                                        } else {
                                                                                                 console.error('Failed to subscribe:', err);
                                                                                               }
                                                                            });
                              });

            client.on('message', (topic, message) => { 
                                                        // Append received message to the messages div
                                                        const messagesDiv = document.getElementById('messages');
                                                        const msg = document.createElement('div');
                                                        msg.textContent = `Topic: ${topic}, Message: ${message.toString()}`;
                                                        messagesDiv.appendChild(msg);
                                                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                                      });
                                                      
            client.on('error', (err) => { 
                                           console.error('Connection error:', err);
                                         });


            client.on('close', () => {
                                        console.log('Disconnected from broker');
                                        document.getElementById('connectBtn').disabled = false;
                                        document.getElementById('disconnectBtn').disabled = true;
                                     });
                       

        
            }
    
    </script>
</body>
</html>
