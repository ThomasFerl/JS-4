<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PivotGrid</title>
<style>
  :root{
    --bg: #0b0c10;            /* dunkles Theme – gern anpassen */
    --card: #121319;
    --muted: #7e8596;
    --fg: #e8ebf1;
    --accent: #5cc8ff;
    --grid-border: #222734;
    --hover: #1b1f2a;
    --sticky: #111522e6;      /* leicht transparent für sticky header */
    --radius: 14px;
  }
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui, Segoe UI, Roboto, Arial;}
  .wrap{padding:20px; display:grid; gap:16px; max-width: 1200px; margin: 0 auto;}
  .title{font-size:20px; font-weight:600;}
  .grid{
    background:var(--card);
    border:1px solid var(--grid-border);
    border-radius:var(--radius);
    overflow:auto;
    box-shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  table{border-collapse:separate; border-spacing:0; width: max-content; min-width:100%;}
  th, td{
    border-right:1px solid var(--grid-border);
    border-bottom:1px solid var(--grid-border);
    padding:10px 12px;
    white-space:nowrap;
    vertical-align:middle;
    position:relative;
  }
  th{font-weight:600; color:var(--muted); background:var(--sticky); backdrop-filter: blur(6px);}
  th.top{position:sticky; top:0; z-index:3;}
  th.left, td.left{position:sticky; left:0; z-index:2; background:linear-gradient(90deg, var(--sticky), transparent 98%);}
  th.corner{z-index:4; border-right:1px solid var(--grid-border);}
  tr:nth-child(even) td{background:rgba(255,255,255,.01);}
  td.value{ text-align:right; font-variant-numeric: tabular-nums; cursor:pointer; }
  td.value:hover, td.value:focus{ outline: none; background:var(--hover); }
  td.total, th.total{ background: linear-gradient(180deg, #1c2130, #161a26); font-weight:700; color:#cfe9ff; }
  .legend{color:var(--muted); font-size:12px;}
  .chip{display:inline-block; height:10px; width:10px; border-radius:50%; margin-right:6px; box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;}
  .hint{ color: var(--muted); }
  .tooltip{
    position:absolute; top:-8px; right:-8px; transform:translateY(-100%);
    background:#0f1320; color:#cfe9ff; padding:6px 8px; border-radius:8px; font-size:12px;
    border:1px solid #1f2a42; white-space:nowrap; box-shadow:0 6px 18px rgba(0,0,0,.4);
    opacity:0; pointer-events:none; transition:.15s ease;
  }
  td.value:hover .tooltip, td.value:focus .tooltip{opacity:1;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Pivot-Auswertung</div>
    <div id="pivot" class="grid"></div>
    <div class="legend">
      <span class="chip" style="background:#0f1a3a"></span>niedrig
      <span class="chip" style="background:#244a92"></span>mittel
      <span class="chip" style="background:#4aa4ff"></span>hoch
      <span class="chip" style="background:#86d1ff"></span>sehr hoch
    </div>
    <div class="hint">Tipp: Klick auf eine Zahl öffnet dein Detail-Fenster (über den Callback).</div>
  </div>

<script>
/**
 * renderPivot
 * container: HTMLElement
 * data: {
 *   rows: [{id, label}], cols: [{id, label}],
 *   values: { "rowId|colId": number }
 * }
 * options:
 *   { formatValue?: fn(number)->string,
 *     showTotals?: boolean,
 *     heatmap?: boolean,
 *     onCellClick?: fn({rowId,colId,value,rowLabel,colLabel,el}) }
 */
function renderPivot(container, data, options = {}) {
  const {
    rows = [], cols = [], values = {},
  } = data;

  const {
    formatValue = (n)=> n==null ? "–" : n.toLocaleString('de-DE'),
    showTotals = true,
    heatmap = true,
    onCellClick = null,
  } = options;

  // compute min/max for heatmap
  let min = Infinity, max = -Infinity;
  for (const r of rows) for (const c of cols) {
    const v = values[`${r.id}|${c.id}`];
    if (typeof v === 'number' && !Number.isNaN(v)) {
      if (v < min) min = v;
      if (v > max) max = v;
    }
  }
  if (min === Infinity) { min = 0; max = 0; }

  // totals
  const rowTotals = {};
  const colTotals = {};
  if (showTotals) {
    for (const r of rows) {
      let sum = 0;
      for (const c of cols) { const v = values[`${r.id}|${c.id}`]; if (typeof v==='number') sum += v; }
      rowTotals[r.id] = sum;
    }
    for (const c of cols) {
      let sum = 0;
      for (const r of rows) { const v = values[`${r.id}|${c.id}`]; if (typeof v==='number') sum += v; }
      colTotals[c.id] = sum;
    }
  }

  // helper: heat color (blue scale)
  function heat(v) {
    if (!heatmap || typeof v !== 'number' || max === min) return '';
    const t = (v - min) / (max - min); // 0..1
    // map 0..1 → darker blue to light/cyan
    // use HSL: hue ~ 210→195, sat 70→95, light 16→70
    const hue = 210 - 15 * t;
    const sat = 70 + 25 * t;
    const light = 16 + 54 * t;
    return `background: hsl(${hue}deg ${sat}% ${light}%); color: ${t>0.6 ? '#0b0f19' : 'var(--fg)'};`;
  }

  // build table
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trTop = document.createElement('tr');

  // corner cell
  const corner = document.createElement('th');
  corner.className = 'top left corner';
  corner.textContent = ' ';
  trTop.appendChild(corner);

  // column headers
  for (const c of cols) {
    const th = document.createElement('th');
    th.className = 'top';
    th.textContent = c.label;
    trTop.appendChild(th);
  }
  if (showTotals) {
    const thT = document.createElement('th');
    thT.className = 'top total';
    thT.textContent = 'Σ';
    trTop.appendChild(thT);
  }

  thead.appendChild(trTop);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  // data rows
  for (const r of rows) {
    const tr = document.createElement('tr');

    const thLeft = document.createElement('th');
    thLeft.className = 'left';
    thLeft.textContent = r.label;
    tr.appendChild(thLeft);

    for (const c of cols) {
      const key = `${r.id}|${c.id}`;
      const val = values[key];
      const td = document.createElement('td');
      td.className = 'value';
      td.tabIndex = 0;

      const inner = document.createElement('div');
      inner.textContent = formatValue(val);
      td.appendChild(inner);

      const tip = document.createElement('div');
      tip.className = 'tooltip';
      tip.textContent = `${r.label} × ${c.label}: ${formatValue(val)}`;
      td.appendChild(tip);

      if (heatmap) td.style = heat(val);

      td.addEventListener('click', (ev)=>{
        if (typeof onCellClick === 'function')
          onCellClick({ rowId: r.id, colId: c.id, value: val, rowLabel: r.label, colLabel: c.label, el: td });
      });
      td.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          td.click();
        }
      });

      tr.appendChild(td);
    }

    if (showTotals) {
      const tdT = document.createElement('td');
      tdT.className = 'value total';
      tdT.textContent = formatValue(rowTotals[r.id]);
      tr.appendChild(tdT);
    }

    tbody.appendChild(tr);
  }

  // footer totals
  if (showTotals) {
    const trSum = document.createElement('tr');
    const thSumLeft = document.createElement('th');
    thSumLeft.className = 'left total';
    thSumLeft.textContent = 'Σ';
    trSum.appendChild(thSumLeft);

    for (const c of cols) {
      const td = document.createElement('td');
      td.className = 'value total';
      td.textContent = formatValue(colTotals[c.id]);
      trSum.appendChild(td);
    }

    const tdGrand = document.createElement('td');
    tdGrand.className = 'value total';
    const grand = Object.values(rowTotals).reduce((a,b)=>a+b,0);
    tdGrand.textContent = formatValue(grand);
    trSum.appendChild(tdGrand);

    tbody.appendChild(trSum);
  }

  table.appendChild(tbody);

  // mount
  container.innerHTML = '';
  container.appendChild(table);
}

/* --- DEMO / BEISPIELDATEN (ersetze das mit deiner Pivot-Matrix) --- */
const demo = {
  rows: [
    { id: 'cc100', label: 'KST 100 – Verwaltung' },
    { id: 'cc200', label: 'KST 200 – Vertrieb' },
    { id: 'cc300', label: 'KST 300 – Produktion' },
  ],
  cols: [
    { id: 'q1', label: 'Q1' },
    { id: 'q2', label: 'Q2' },
    { id: 'q3', label: 'Q3' },
    { id: 'q4', label: 'Q4' },
  ],
  values: {
    'cc100|q1': 12034, 'cc100|q2': 15440, 'cc100|q3': 14110, 'cc100|q4': 16880,
    'cc200|q1': 22010, 'cc200|q2': 19990, 'cc200|q3': 24500, 'cc200|q4': 23040,
    'cc300|q1': 40500, 'cc300|q2': 39800, 'cc300|q3': 42220, 'cc300|q4': 45090,
  }
};

const pivotEl = document.getElementById('pivot');
renderPivot(pivotEl, demo, {
  showTotals: true,
  heatmap: true,
  formatValue: n => (n==null ? '–' : n.toLocaleString('de-DE')),
  onCellClick: ({rowId, colId, value, rowLabel, colLabel}) => {
    // HIER dein Detail-Fenster öffnen:
    // z.B. window.open('details.html?row='+rowId+'&col='+colId, '_blank')
    console.log('CELL CLICK', {rowId, colId, value, rowLabel, colLabel});
    alert(`${rowLabel} × ${colLabel}\nWert: ${value?.toLocaleString('de-DE') ?? '–'}\nIDs: ${rowId} | ${colId}`);
  }
});
</script>
</body>
</html>

