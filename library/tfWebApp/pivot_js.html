<!doctype html>
<html lang="de">
<head>
   <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>PivotGrid</title>
   <link rel="stylesheet" href="./style.css">

</head>
<body>
  <div class="pivotWrap">
    <div class="pivotTitle">Pivot-Auswertung</div>
    <div id="pivot" class="pivotGrid"></div>
    <div class="pivotLegend">
      <span class="pivotChip" style="background:#0f1a3a"></span>niedrig
      <span class="pivotChip" style="background:#244a92"></span>mittel
      <span class="pivotChip" style="background:#4aa4ff"></span>hoch
      <span class="pivotChip" style="background:#86d1ff"></span>sehr hoch
    </div>
    <div class="pivotHint">Tipp: Klick auf eine Zahl öffnet dein Detail-Fenster (über den Callback).</div>
  </div>

<script>
/**
 * renderPivot
 * container: HTMLElement
 * data: {
 *   rows: [{id, label}], cols: [{id, label}],
 *   values: { "rowId|colId": number }
 * }
 * options:
 *   { formatValue?: fn(number)->string,
 *     showTotals?: boolean,
 *     heatmap?: boolean,
 *     onCellClick?: fn({rowId,colId,value,rowLabel,colLabel,el}) }
 */

function renderPivot( container, data, options = {} ) 
{
  const {
          rows = [], cols = [], values = {},
        } = data;

  const 
  {
    formatValue  = (n)=> n==null ? "–" : n.toLocaleString('de-DE'),
    showTotals   = true,
    heatmap      = true,
    onCellClick  = null,
  } = options;

  // compute min/max for heatmap
  let min = Infinity, max = -Infinity;
  for (const r of rows) for (const c of cols) {
    const v = values[`${r.id}|${c.id}`];
    if (typeof v === 'number' && !Number.isNaN(v)) {
      if (v < min) min = v;
      if (v > max) max = v;
    }
  }
  if (min === Infinity) { min = 0; max = 0; }

  // totals
  const rowTotals = {};
  const colTotals = {};
  if (showTotals) 
  {
    for (const r of rows) {
      let sum = 0;
      for (const c of cols) { const v = values[`${r.id}|${c.id}`]; if (typeof v==='number') sum += v; }
      rowTotals[r.id] = sum;
    }
    
    for (const c of cols) 
    {
      let sum = 0;
      for (const r of rows) { const v = values[`${r.id}|${c.id}`]; if (typeof v==='number') sum += v; }
      colTotals[c.id] = sum;
    }
  }

  // helper: heat color (blue scale)
  function heat(v) 
  {
    if (!heatmap || typeof v !== 'number' || max === min) return '';
    const t = (v - min) / (max - min); // 0..1
    // map 0..1 → darker blue to light/cyan
    // use HSL: hue ~ 210→195, sat 70→95, light 16→70
    const hue = 210 - 15 * t;
    const sat = 70 + 25 * t;
    const light = 16 + 54 * t;
    return `background: hsl(${hue}deg ${sat}% ${light}%); color: ${t>0.6 ? '#0b0f19' : 'var(--fg)'};`;
  }

  // build table
  const table = document.createElement('table');
        table.className = 'pivotTable';

  const thead = document.createElement('thead');
        thead.className = 'pivotThead';

  const trTop = document.createElement('tr');
        trTop.className = 'pivotTrTop';


        // corner cell
  const corner = document.createElement('th');
  corner.className = 'pivotTh'; // top left corner';
  corner.textContent = ' ';
  trTop.appendChild(corner);

  // column headers
  for (const c of cols) {
    const th = document.createElement('th');
    th.className = 'pivotTh'; //'pivotTop';
    th.textContent = c.label;
    trTop.appendChild(th);
  }
  if (showTotals) {
    const thT = document.createElement('th');
    thT.className = 'top total';
    thT.textContent = 'Σ';
    trTop.appendChild(thT);
  }

  thead.appendChild(trTop);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  // data rows
  for (const r of rows) {
    const tr = document.createElement('tr');

    const thLeft = document.createElement('th');
    thLeft.className = 'left';
    thLeft.textContent = r.label;
    tr.appendChild(thLeft);

    for (const c of cols) {
      const key = `${r.id}|${c.id}`;
      const val = values[key];
      const td = document.createElement('td');
      td.className = 'value';
      td.tabIndex = 0;

      const inner = document.createElement('div');
      inner.textContent = formatValue(val);
      td.appendChild(inner);

      const tip = document.createElement('div');
      tip.className = 'tooltip';
      tip.textContent = `${r.label} × ${c.label}: ${formatValue(val)}`;
      td.appendChild(tip);

      if (heatmap) td.style = heat(val);

      td.addEventListener('click', (ev)=>{
        if (typeof onCellClick === 'function')
          onCellClick({ rowId: r.id, colId: c.id, value: val, rowLabel: r.label, colLabel: c.label, el: td });
      });
      td.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          td.click();
        }
      });

      tr.appendChild(td);
    }

    if (showTotals) {
      const tdT = document.createElement('td');
      tdT.className = 'value total';
      tdT.textContent = formatValue(rowTotals[r.id]);
      tr.appendChild(tdT);
    }

    tbody.appendChild(tr);
  }

  // footer totals
  if (showTotals) {
    const trSum = document.createElement('tr');
    const thSumLeft = document.createElement('th');
    thSumLeft.className = 'left total';
    thSumLeft.textContent = 'Σ';
    trSum.appendChild(thSumLeft);

    for (const c of cols) {
      const td = document.createElement('td');
      td.className = 'value total';
      td.textContent = formatValue(colTotals[c.id]);
      trSum.appendChild(td);
    }

    const tdGrand = document.createElement('td');
    tdGrand.className = 'value total';
    const grand = Object.values(rowTotals).reduce((a,b)=>a+b,0);
    tdGrand.textContent = formatValue(grand);
    trSum.appendChild(tdGrand);

    tbody.appendChild(trSum);
  }

  table.appendChild(tbody);

  // mount
  container.innerHTML = '';
  container.appendChild(table);
}

/* --- DEMO / BEISPIELDATEN (ersetze das mit deiner Pivot-Matrix) --- */
const demo = {
  rows: [
    { id: 'cc100', label: 'KST 100 – Verwaltung' },
    { id: 'cc200', label: 'KST 200 – Vertrieb' },
    { id: 'cc300', label: 'KST 300 – Produktion' },
  ],
  cols: [
    { id: 'q1', label: 'Q1' },
    { id: 'q2', label: 'Q2' },
    { id: 'q3', label: 'Q3' },
    { id: 'q4', label: 'Q4' },
  ],
  values: {
    'cc100|q1': 12034, 'cc100|q2': 15440, 'cc100|q3': 14110, 'cc100|q4': 16880,
    'cc200|q1': 22010, 'cc200|q2': 19990, 'cc200|q3': 24500, 'cc200|q4': 23040,
    'cc300|q1': 40500, 'cc300|q2': 39800, 'cc300|q3': 42220, 'cc300|q4': 45090,
  }
};

const pivotEl = document.getElementById('pivot');
renderPivot(pivotEl, demo, {
  showTotals: true,
  heatmap: true,
  formatValue: n => (n==null ? '–' : n.toLocaleString('de-DE')),
  onCellClick: ({rowId, colId, value, rowLabel, colLabel}) => {
    // HIER dein Detail-Fenster öffnen:
    // z.B. window.open('details.html?row='+rowId+'&col='+colId, '_blank')
    console.log('CELL CLICK', {rowId, colId, value, rowLabel, colLabel});
    alert(`${rowLabel} × ${colLabel}\nWert: ${value?.toLocaleString('de-DE') ?? '–'}\nIDs: ${rowId} | ${colId}`);
  }
});
</script>
</body>
</html>

